---
import Section from "./Section.astro";
import type { ContactProps } from "@types";

type Props = ContactProps;

const { title, description } = Astro.props;
---

<Section text={title} href="contact">
  <div class="flex flex-col gap-8">
    <p class="w-full text-base text-neutral">
      {description}
    </p>

    <form
      id="contact-form"
      class="w-full max-w-2xl"
      method="POST"
      action="/api/contact"
    >
      <div class="rounded-lg bg-transparent p-6 shadow-sm md:p-8">
        <div class="space-y-4">
          <div>
            <label for="name" class="block text-sm font-medium text-neutral mb-1">Name</label>
            <input
              id="name"
              name="name"
              type="text"
              required
              class="w-full rounded-md border border-neutral-600 bg-transparent px-3 py-2 text-white text-sm md:text-base focus:border-primary focus:ring-2 focus:ring-primary/20 focus:outline-none"
            />
          </div>

          <div>
            <label for="email" class="block text-sm font-medium text-neutral mb-1">Email</label>
            <input
              id="email"
              name="email"
              type="email"
              required
              class="w-full rounded-md border border-neutral-600 bg-transparent px-3 py-2 text-white text-sm md:text-base focus:border-primary focus:ring-2 focus:ring-primary/20 focus:outline-none"
            />
          </div>

          <div>
            <label for="message" class="block text-sm font-medium text-neutral mb-1">Message</label>
            <textarea
              id="message"
              name="message"
              rows="5"
              required
              class="w-full rounded-md border border-neutral-600 bg-transparent px-3 py-2 text-white text-sm md:text-base focus:border-primary focus:ring-2 focus:ring-primary/20 focus:outline-none resize-none"
            ></textarea>
          </div>

          <div class="flex items-center justify-between pt-2">
            <button
              type="submit"
              class="inline-block rounded-full bg-primary px-8 py-5 text-sm leading-5 font-medium text-white"
            >
              Send Message
            </button>

            <div id="contact-status" class="text-sm text-neutral" role="status" aria-live="polite"></div>
          </div>
        </div>
      </div>
    </form>
  </div>
</Section>
>

<script type="module">
  const form = document.getElementById("contact-form");
  const statusEl = document.getElementById("contact-status");
  if (form) {
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalBtnText = submitBtn?.textContent || "Send Message";

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const name = form.querySelector("#name")?.value || "";
      const email = form.querySelector("#email")?.value || "";
      const message = form.querySelector("#message")?.value || "";

      if (!name || !email || !message) {
        statusEl.textContent = "Please fill out all fields.";
        statusEl.className = "mt-2 text-sm text-yellow-300";
        return;
      }

      try {
        if (submitBtn) {
          submitBtn.disabled = true;
          submitBtn.textContent = "Sending...";
        }

        statusEl.textContent = "";

        const res = await fetch("/api/contact", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name, email, message }),
        });

        const payload = await res.json().catch(() => ({}));

        if (res.ok && payload.ok) {
          statusEl.textContent = "Message sent â€” thanks!";
          statusEl.className = "mt-2 text-sm text-green-400";
          form.reset();
        } else {
          const err = payload.error || "Failed to send message.";
          statusEl.textContent = err;
          statusEl.className = "mt-2 text-sm text-red-400";
        }
      } catch (err) {
        statusEl.textContent = "Server error. Please try again later.";
        statusEl.className = "mt-2 text-sm text-red-400";
      } finally {
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.textContent = originalBtnText;
        }

        // remove the status message after a short delay
        setTimeout(() => {
          statusEl.textContent = "";
          statusEl.className = "mt-2 text-sm";
        }, 6000);
      }
    });
  }
</script>
